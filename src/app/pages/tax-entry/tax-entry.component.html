<div class="page-header">
  <div class="page-title">
    <div class="page-title-icon"><i class="pi pi-file"></i></div>
    <div><h2>Tax Entry</h2><p>Record tax payments</p></div>
  </div>
</div>

<div class="card">
  <div class="card-header"><h3><i class="pi pi-file-edit"></i> New Tax Entry</h3></div>
  <div class="card-body">
    <form [formGroup]="form" (ngSubmit)="save()">
      <div class="form-row">
        <div class="form-group">
          <label>Village <span class="required">*</span></label>
          <p-select [appendTo]="'body'" [filter]="true" [options]="villages" optionLabel="name" optionValue="name" formControlName="villageName" class="form-control" (onChange)="onVillageChange($event.value)"></p-select>
          @if (form.controls.villageName.invalid && form.controls.villageName.touched) {
            <div class="field-error">Village is required.</div>
          }
        </div>
        <div class="form-group">
          <label>Devotee <span class="required">*</span></label>
          <p-select [appendTo]="'body'" [filter]="true" [options]="filteredDevotees" optionLabel="taxpersonName" optionValue="taxpersonName" formControlName="devoteeName" class="form-control" (onChange)="onDevoteeChange($event.value)"></p-select>
          @if (form.controls.devoteeName.invalid && form.controls.devoteeName.touched) {
            <div class="field-error">Devotee is required.</div>
          }
        </div>
        <div class="form-group"><label>Tax Type</label><p-select [appendTo]="'body'" [filter]="true" [options]="taxTypeOptions" formControlName="taxType" class="form-control"></p-select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Year <span class="required">*</span></label><p-inputnumber formControlName="year" class="form-control"></p-inputnumber></div>
        <div class="form-group">
          <label>Amount <span class="required">*</span></label>
          <p-inputnumber formControlName="amount" mode="currency" currency="INR" locale="en-IN" class="form-control"></p-inputnumber>
          @if (form.controls.amount.invalid && form.controls.amount.touched) {
            <div class="field-error">Amount must be greater than 0.</div>
          }
        </div>
        <div class="form-group"><label>Payment Date <span class="required">*</span></label><input pInputText type="date" class="form-control" formControlName="paymentDate"></div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Payment Status <span class="required">*</span></label>
          <p-select [appendTo]="'body'" [filter]="true" [options]="paymentStatusOptions" optionLabel="label" optionValue="value" formControlName="paid" class="form-control"></p-select>
        </div>
      </div>
      <div class="btn-group">
        <button pButton class="btn btn-primary" type="submit" label="Save" icon="pi pi-save" [loading]="isSaving" [disabled]="isSaving"></button>
      </div>
      @if (formMessage) {
        <div class="form-notice success">{{ formMessage }}</div>
      }
      @if (formError) {
        <div class="form-notice error">{{ formError }}</div>
      }
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h3><i class="pi pi-list"></i> Tax Entries</h3>
    <div class="table-actions">
      <button pButton class="btn btn-secondary" icon="pi pi-file-excel" label="Excel" (click)="exportExcel()"></button>
      <button pButton class="btn btn-secondary" icon="pi pi-file-pdf" label="PDF" (click)="exportPdf()"></button>
      <button pButton class="btn btn-secondary" icon="pi pi-print" label="Print" (click)="printTable()"></button>
    </div>
  </div>
  <div class="card-body table-wrap">
    <p-table [value]="entries" styleClass="data-table">
      <ng-template pTemplate="header"><tr><th>Devotee</th><th>Village</th><th>Year</th><th>Amount</th><th>Status</th></tr></ng-template>
      <ng-template pTemplate="body" let-item>
        <tr>
          <td>{{ item.devoteeName }}</td>
          <td>{{ item.villageName }}</td>
          <td>{{ item.year }}</td>
          <td>{{ item.amount | currency : 'INR' : 'symbol' : '1.0-0' }}</td>
          <td><p-tag [value]="item.paid ? 'Paid' : 'Pending'" [severity]="item.paid ? 'success' : 'warn'"></p-tag></td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

